<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="utils/css/bootstrap.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" type="text/css" href="main.css">
    <link rel="stylesheet" href="TemplateTesting/footer.css">
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="utils/jquery-latest.js"></script>
    <script src="utils/popper.min.js"></script>
    <script src="utils/js/bootstrap.min.js"></script>

  </head>
  <body onload="on_load()">
    <div class="container collapse" id="basketCollapse">
      <div class="pt-3 pb-3 border-bottom container">
        <div class="row">
          <div class="col-6">
            <h3 class="serif">Your Basket (<span id=basket_items>0</span>)</h3>
          </div>
          <div class="col-6">
            <button type="button" class="btn btn-default float-right sansserif" data-toggle="collapse" data-target="#basketCollapse">Close X</button>
          </div>
        </div>
      </div>
      <div class="pt-3 pb-3 d-flex container justify-content-center border-bottom">
        <table class="table table-bordered w-auto mt-2">
          <thead>
            <tr class="serif">
              <th scope="col">Week Day</th>
              <th scope="col">Plates</th>
            </tr>
          </thead>
          <tbody class="sansserif">
            <tr>
             <th scope="row">Monday</th>
             <td>
               <div class="container">
                 <div class="row" id="basket_monday">
                 </div>
               </div>
             </td>
            </tr>

            <tr>
              <th scope="row">Tuesday</th>
              <td>
                <div class="container">
                  <div class="row" id="basket_tuesday">
                  </div>
                </div>
              </td>
            </tr>

            <tr>
              <th scope="row">Wednesday</th>
              <td>
                <div class="container" id="basket_wednesday">
                  <div class="row">
                  </div>
                </div>
              </td>
            </tr>

            <tr>
              <th scope="row">Thursday</th>
              <td>
                <div class="container" id="basket_thursday">
                  <div class="row">
                  </div>
                </div>
              </td>
            </tr>

            <tr>
              <th scope="row">Friday</th>
              <td>
                <div class="container" id="basket_friday">
                  <div class="row">
                  </div>
                </div>
              </td>
            </tr>

            <tr>
              <th scope="row">Saturday</th>
              <td>
                <div class="container" id="basket_saturday">
                  <div class="row">
                  </div>
                </div>
              </td>
            </tr>

            <tr>
              <th scope="row">Sunday</th>
              <td>
                <div class="container" id="basket_sunday">
                  <div class="row">
                  </div>
                </div>
              </td>
            </tr>

          </tbody>
        </table>
      </div>
      <div class="pt-3 pb-3 pl-5 pr-5 container border-bottom sansserif">
        <div class="row">
          <div class="col-6">
            <span>SUBTOTAL</span>
          </div>
          <div class="col-6">
            <span class="float-right" id="basket_price">0.0 $</span>
          </div>
        </div>
      </div>
      <div class="pt-3 pb-3 pl-5 pr-5 container border-bottom d-flex justify-content-center sansserif">
        <a type="button" class="btn btn-primary" href="Success.html">Checkout</a>
      </div>
    </div>

    <div class="container-fluid brand-color navbar-pad">
      <div class="container">
        <div class="row no-gutters">
          <div class="col-8">
            <nav class="navbar navbar-expand-md navbar-light">
              <button class="navbar-toggler btn-nav" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
              </button>
              <a class="navbar-brand mx-auto serif" href="Home.html">Edu Eats</a>
              <div class="collapse navbar-collapse mx-auto" id="navbarSupportedContent">
                <ul class="navbar-nav mr-auto">
                  <li class="nav-item">
                    <a class="nav-link  mx-auto" href="Home.html">Home</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link  mx-auto" href="Cataleg.html">Our Meals</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link  mx-auto" href="NotFound.html">Weekly Diets</a>
                  </li>
                </ul>
              </div>
            </nav>
          </div>
          <div class="col pr-4 pt-2 pb-3">
            <button type="button" class="btn float-right btn-nav" data-toggle="collapse" data-target="#basketCollapse">Basket (<span id="navbar_basket_items">0</span>)</button>
          </div>
        </div>
      </div>
    </div>

    <div class="container pl-0 pr-0">
      <div class="pt-3 pb-3 border-bottom container text-center">
        <h3 class="serif">
          COMPLETE MEALS
        </h3>
        <p class="sansserif">
          Healthy meals for a full breakfast, luch or dinner. You won't feel hungry!
        </p>
      </div>
      <div class="border-bottom">
        <a class="nav-link" data-toggle="collapse" href="#collapseExample" role="button" aria-expanded="false" aria-controls="collapseExample">
          <b><i>Filter by...</b></i>
        </a>
      </div>
      <div class="collapse" id="collapseExample">
        <div class="container ml-2 mr-2">
          <div class="h5 row">
            Diet
          </div>
          <div class="row">
            <div class="col">
              <div class="form-check">
                <input type="checkbox" class="form-check-input" id="vegan_check" onchange="on_checkbox_change(this, 'Vegan', 'diet')">
                <label class="form-check-label" for="exampleCheck1">Vegan</label>
              </div>
            </div>
            <div class="col">
              <div class="form-check">
                <input type="checkbox" class="form-check-input" id="med_check" onchange="on_checkbox_change(this, 'Mediterranean', 'diet')">
                <label class="form-check-label" for="exampleCheck2">Mediterranean</label>
              </div>
            </div>
            <div class="col">
              <div class="form-check">
                <input type="checkbox" class="form-check-input" id="paleo_check" onchange="on_checkbox_change(this, 'Paleolithic', 'diet')">
                <label class="form-check-label" for="exampleCheck1">Paleolithic</label>
              </div>
            </div>
          </div>

          <div class="h5 row">
            Macro-nutrients
          </div>
          <div class="row">
            <div class="col">
              <div class="form-check">
                <input type="checkbox" class="form-check-input" id="highcarb_check" onchange="on_checkbox_change(this, 'High Carbs', 'macro')">
                <label class="form-check-label" for="exampleCheck1">High Carbs</label>
              </div>
            </div>
            <div class="col">
              <div class="form-check">
                <input type="checkbox" class="form-check-input" id="highprot_check" onchange="on_checkbox_change(this, 'High Protein', 'macro')">
                <label class="form-check-label" for="exampleCheck1">High Protein</label>
              </div>
            </div>
            <div class="col">
              <div class="form-check">
                <input type="checkbox" class="form-check-input" id="highfat_check" onchange="on_checkbox_change(this, 'High Fiber', 'macro')">
                <label class="form-check-label" for="exampleCheck1">High Fiber</label>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col">
              <div class="form-check">
                <input type="checkbox" class="form-check-input" id="lowcarb_check" onchange="on_checkbox_change(this, 'Low Carbs', 'macro')">
                <label class="form-check-label" for="exampleCheck1">Low Carbs</label>
              </div>
            </div>
            <div class="col">
              <div class="form-check">
                <input type="checkbox" class="form-check-input" id="lowprot_check" onchange="on_checkbox_change(this, 'Low Protein', 'macro')">
                <label class="form-check-label" for="exampleCheck1">Low Protein</label>
              </div>
            </div>
            <div class="col">
              <div class="form-check">
                <input type="checkbox" class="form-check-input" id="lowfat_check" onchange="on_checkbox_change(this, 'Low Fat', 'macro')">
                <label class="form-check-label" for="exampleCheck1">Low Fat</label>
              </div>
            </div>
          </div>

          <div class="h5 row">
            Allergens
          </div>
          <div class="row">
            <div class="col">
              <div class="form-check">
                <input type="checkbox" class="form-check-input" id="gluten_check" onchange="on_checkbox_change(this, 'Gluten Free', 'alergen')">
                <label class="form-check-label" for="exampleCheck1">Gluten Free</label>
              </div>
            </div>
            <div class="col">
              <div class="form-check">
                <input type="checkbox" class="form-check-input" id="seaf_check" onchange="on_checkbox_change(this, 'Seafood Free', 'alergen')">
                <label class="form-check-label" for="exampleCheck1">Seafood Free</label>
              </div>
            </div>
            <div class="col">
              <div class="form-check">
                <input type="checkbox" class="form-check-input" id="nut_check" onchange="on_checkbox_change(this, 'Nut Free', 'alergen')">
                <label class="form-check-label" for="exampleCheck1">Nuts Free</label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="container d-flex flex-wrap pt-2 pb-3" id='plat_container'>
      </div>
    </div>
    <!-- Footer -->
    <section id="footer">
      <div class="container">
        <div class="row text-center text-xs-center text-sm-left text-md-left">
          <div class="col-xs-12 col-sm-4 col-md-4">
            <h5>Quick links</h5>
            <ul class="list-unstyled quick-links">
              <li><a href="Home.html"><i class="fa fa-angle-double-right"></i>Home</a></li>
              <li><a href="Cataleg.html"><i class="fa fa-angle-double-right"></i>Our Meals</a></li>
              <li><a href="NotFound.html"><i class="fa fa-angle-double-right"></i>Weekly Diets</a></li>
            </ul>
          </div>
        </div>
        <div class="row">
          <div class="col-xs-12 col-sm-12 col-md-12 mt-2 mt-sm-5">
            <ul class="list-unstyled list-inline social text-center">
              <li class="list-inline-item"><a href="NotFound.html"><i class="fa fa-facebook"></i></a></li>
              <li class="list-inline-item"><a href="NotFound.html"><i class="fa fa-twitter"></i></a></li>
              <li class="list-inline-item"><a href="NotFound.html"><i class="fa fa-instagram"></i></a></li>
              <li class="list-inline-item"><a href="NotFound.html"><i class="fa fa-google-plus"></i></a></li>
              <li class="list-inline-item"><a href="NotFound.html" target="_blank"><i class="fa fa-envelope"></i></a></li>
            </ul>
          </div>
          <hr>
        </div>
        <div class="row">
          <div class="col-xs-12 col-sm-12 col-md-12 mt-2 mt-sm-2 text-center">
            <p class="h6">Â© All right Reversed.<a class="ml-2" href="NotFound.html" target="_blank">EduEats</a></p>
          </div>
          <hr>
        </div>
      </div>
    </section>
    <!-- ./Footer -->
    <template id="plat_preview3">
      <div class="container mt-1 ml-1 mr-1 mb-1">
        <div class="card card-catalog">
          <a href="Plat.html"><img id="card_img" class="img-fluid card-img-top card-catalog-image"  src="assets\plats\canelons.png" alt="Plat"></a>

          <div class="card-body border-bottom pt-2 pb-2">
                <h5 class="feature-title mb-0 mt-0 serif" id="card_title">Lorem ipsum</h5>
          </div>
          <div class="card-body pt-2 pb-2 sansserif">
            <div class="container-botons">
              <div class="row">
                <div class="col-6 d-flex align-items-center">
                  <span id="card_price" class="float-left">0.0$</span>
                </div>
                <div class="col-6">
                  <div class="dropdown">
                    <button class="btn dropdown-toggle btn-sm btn-nav brand-color" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                      BUY
                    </button>
                    <div class="dropdown-menu" aria-labelledby="dropdownMenuButton" id="card_selector" data-id="#">
                      <button class="dropdown-item" onclick="add_to_basket(this.parentElement.getAttribute('data-id'),0)">Monday</button>
                      <button class="dropdown-item" onclick="add_to_basket(this.parentElement.getAttribute('data-id'),1)">Tuesday</button>
                      <button class="dropdown-item" onclick="add_to_basket(this.parentElement.getAttribute('data-id'),2)">Wednesday</button>
                      <button class="dropdown-item" onclick="add_to_basket(this.parentElement.getAttribute('data-id'),3)">Thursday</button>
                      <button class="dropdown-item" onclick="add_to_basket(this.parentElement.getAttribute('data-id'),4)">Friday</button>
                      <button class="dropdown-item" onclick="add_to_basket(this.parentElement.getAttribute('data-id'),5)">Saturday</button>
                      <button class="dropdown-item" onclick="add_to_basket(this.parentElement.getAttribute('data-id'),6)">Sunday</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </template>

  <template id="basket_meal">
    <div class="card card-basket">
      <img id="card_img" class="img-fluid card-img-top card-basket-image" src="assets\plats\canelons.png" alt="Plat">

      <div class="card-body border-bottom pt-2 pb-2 pl-1 pr-1">
        <div class="container">
          <div class="row">
            <div class="col-6 d-flex align-items-center">
               <h5 class="feature-title mb-0 mt-0 card-title-font serif" id="card_title" >Tagliatelle</h5>
            </div>
            <div class="col-6">
              <button id="card_selector" class="btn btn-danger float-right pt-0 pb-0 pl-0 pr-0 card-basket-button" data-idx="#" data-day="#" onclick="remove_from_basket(this.getAttribute('data-idx'), this.getAttribute('data-day'))">&#x2015;</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </template>

    <script>
      var imgFolder = "assets/plats/";
      var catalog = [
            {
              id : 0,
              name : "Tagliatelle",
              diet_tags : ["Mediterranean"],
              macro_tags: ["High Carbs", "Low Fat"],
              alergen_tags: ["Seafood Free"],
              thumbnail : "tagliattelle.png",
              price : 6.45
            },
            {
              id : 1,
              name : "Canelonni",
              diet_tags : ["Mediterranean"],
              macro_tags: ["High Carbs"],
              alergen_tags: ["Seafood Free", "Nut Free"],
              thumbnail : "canelons.png",
              price : 6.65
            },
            {
              id : 2,
              name : "Pizza",
              diet_tags : ["Mediterranean"],
              macro_tags: ["High Carbs", "High Protein"],
              alergen_tags: ["Seafood Free", "Nut Free"],
              thumbnail : "pizza.png",
              price : 8.70
            },
            {
              id : 3,
              name : "Egg toast",
              diet_tags : [],
              macro_tags: ["High Carbs", "High Protein"],
              alergen_tags: ["Seafood Free", "Nut Free"],
              thumbnail : "toast.png",
              price : 4.5
            },
            {
              id : 4,
              name : "Cucumber Salad",
              diet_tags : ["Mediterranean", "Vegan"],
              macro_tags: ["Low Carbs", "Low Protein", "High Fiber", "Low Fat"],
              alergen_tags: ["Seafood Free", "Gluten Free"],
              thumbnail : "cucumber.jpg",
              price : 5.25
            },
            {
              id : 5,
              name : "Steak Chimichurri",
              diet_tags : ["Paleolithic"],
              macro_tags: ["Low Carbs", "High Protein"],
              alergen_tags: ["Seafood Free", "Gluten Free"],
              thumbnail : "steak.jpg",
              price : 19.99
            },
            {
              id : 6,
              name : "Salmon",
              diet_tags : ["Paleolithic", "Mediterranean"],
              macro_tags: ["Low Carbs", "High Protein"],
              alergen_tags: ["Gluten Free"],
              thumbnail : "salmon.jpg",
              price : 12.99
            }
          ];

      var diet_filters = [];
      var macro_filters = [];
      var alergen_filters = [];

      function on_checkbox_change(checkbox, tag, filterType){
        switch(filterType){
          case 'diet':
            if(checkbox.checked){
              add_filter(diet_filters, tag);
            }else{
              remove_filter(diet_filters, tag);
            }
            break;
          case 'macro':
            if(checkbox.checked){
              add_filter(macro_filters, tag);
            }else{
              remove_filter(macro_filters, tag);
            }
            break;
          case 'alergen':
            if(checkbox.checked){
              add_filter(alergen_filters, tag);
            }else{
              remove_filter(alergen_filters, tag);
            }
            break;
          default:
            console.error("Invalid filter");
        }
        show_content();
      }

      function add_filter(list, tag){
        if(list.indexOf(tag)==-1){
          list.push(tag);
        }
      }

      function remove_filter(list, tag){
        for(var i = 0; i < list.length; i++){
          if(list[i] == tag){
            list.splice(i, 1);
          }
        }
      }

      function remove_from_basket(meal_idx, day){
        console.log(""+meal_idx+" "+day);
        var bc = getCookie('basket');
        if(bc != ""){
          var basket_list = JSON.parse(bc);
          basket_list[day].splice(meal_idx, 1);
        }
        var basket_string = JSON.stringify(basket_list);
        setCookie('basket', basket_string, 1);
        update_basket();
      }

      function add_to_basket(meal_id, day){
        console.log(""+meal_id+" "+day);
        var meal = getMeal(meal_id);
        var bc = getCookie('basket');
        if(bc == ""){
          bc = [ [], [], [], [], [], [], [] ];
        }else{
          bc = JSON.parse(bc);
        }
        bc[day].push(meal);
        var basket_string = JSON.stringify(bc);
        setCookie('basket', basket_string, 1);
        update_basket();
      }

      function getMeal(meal_id){
        for(var i = 0; i < catalog.length; i++){
          if(catalog[i].id == meal_id){
            return catalog[i];
          }
        }
        console.error("meal id not found");
        return null;
      }

      function update_basket(){
        var bc = getCookie('basket');
        console.log("cookie: "+bc);
        var item = document.getElementById("basket_meal").content.querySelector("div");
        if(bc != ""){
          var basket_list = JSON.parse(bc);
          console.log("basket_list" + typeof(basket_list));
          var basketday = ['basket_monday', 'basket_tuesday', 'basket_wednesday', 'basket_thursday', 'basket_friday', 'basket_saturday', 'basket_sunday'];
          var total_price = 0;
          var total_items = 0;
          for(var i = 0; i < basketday.length; i++){
            var day_n = document.getElementById(basketday[i]);
            while (day_n.lastElementChild) {
              day_n.removeChild(day_n.lastElementChild);
            }
            var meal_list = basket_list[i];
            for(var j = 0; j < meal_list.length; j++){
              console.log("basket_item "+ meal_list[j]);
              var newCard = document.importNode(item, true);
              var img = newCard.querySelector("#card_img");
              img.src=imgFolder.concat(meal_list[j].thumbnail);
              img.alt=meal_list[j].name;
              var title = newCard.querySelector("#card_title");
              title.textContent = meal_list[j].name;
              var deleteDom = newCard.querySelector("#card_selector");
              deleteDom.setAttribute('data-idx', j);
              deleteDom.setAttribute('data-day', i);
              total_price += meal_list[j].price;
              total_items += 1;
              day_n.appendChild(newCard);
            }
          }
          console.log("total_items: "+total_items);
          document.getElementById("basket_price").textContent=""+total_price+" $";
          document.getElementById("basket_items").textContent=""+total_items;
          document.getElementById("navbar_basket_items").textContent=""+total_items;
        }
      }

      function setCookie(cname, cvalue, exdays) {
        var d = new Date();
        d.setTime(d.getTime() + (exdays*24*60*60*1000));
        var expires = "expires="+ d.toUTCString();
        document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
      }

      function getCookie(cname) {
        var name = cname + "=";
        var decodedCookie = decodeURIComponent(document.cookie);
        var ca = decodedCookie.split(';');
        for(var i = 0; i <ca.length; i++) {
          var c = ca[i];
          while (c.charAt(0) == ' ') {
            c = c.substring(1);
          }
          if (c.indexOf(name) == 0) {
            return c.substring(name.length, c.length);
          }
        }
        return "";
      }

      function on_load(){
        update_basket();
        show_content();
      }

      function show_content() {
        var item = document.getElementById("plat_preview3").content.querySelector("div");
        console.log(JSON.stringify(diet_filters));
        var fc = get_filtered_catalog();
        var plat_container = document.getElementById("plat_container");
        while (plat_container.lastElementChild) {
          plat_container.removeChild(plat_container.lastElementChild);
        }
        for (i = 0; i<fc.length; i++){
          var newCard = document.importNode(item, true);
          var img = newCard.querySelector("#card_img");
          img.src=imgFolder.concat(fc[i].thumbnail);
          img.alt=fc[i].id;

          var title = newCard.querySelector("#card_title");
          title.textContent = fc[i].name;

          var price = newCard.querySelector("#card_price");
          price.textContent = fc[i].price;

          var domId = newCard.querySelector("#card_selector");
          domId.setAttribute('data-id', fc[i].id);

          var row = document.createElement("div");
          row.className="row";
          row.appendChild(newCard)

          plat_container.appendChild(row);
        }
      }

      function get_filtered_catalog(){
        return catalog.filter(function(meal){
          return filter_pass(meal.diet_tags, meal.macro_tags, meal.alergen_tags)
        });
      }

      function filter_pass(diet_tags, macro_tags, alergen_tags){
        var diet_pass = true;
        var macro_pass = true;
        var alergen_pass = true;

        for(var i = 0; i < diet_filters.length; i++){
          if(diet_tags.indexOf(diet_filters[i])==-1){
            diet_pass = false;
            break;
          }
        }

        for(var i = 0; i < macro_filters.length; i++){
          if(macro_tags.indexOf(macro_filters[i])==-1){
            macro_pass = false;
            break;
          }
        }

        for(var i = 0; i < alergen_filters.length; i++){
          if(alergen_tags.indexOf(alergen_filters[i])==-1){
            alergen_pass = false;
            break;
          }
        }
        return diet_pass && macro_pass && alergen_pass;
      }

    </script>
  </body>
</html>
